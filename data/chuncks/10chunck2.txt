with More Segments Flag set to 1 Figure 7 Example Header of the SOMEIP segments The last segment ie 5 contains the remaining 312 Payload bytes of the original 5771 bytes payload This last segment is marked with More Segments flag set to 0 Figure 8 Example Header of the last SOMEIP segment Specification on SOMEIP Transport Protocol AUTOSAR CP R2011 17 of 59 Document ID 809AUTOSARSWSSOMEIPTransportProtocol 72 Segmentation of SOMEIP me ssages TX Path The following chapter describe the necessary activities of the SOMEIP TP module to segment SOMEIP messages 721 Size of SOMEIP segments SWSSomeIpTp00 001 The SOMEIP TP module shall remember the PDU length separately for every PDU ID which is passed by the PduInfoPtr parameter of the SomeIpTpTransmit call RSSOMEIP00010 RSSOMEIP00011 Note The SOMEIP TP module needs this information to calculate the payload size the Offset Value and the More Segments Flag for the SOM EIP segments which are going to be transmitted SWSSomeIpTp00 002 The amount of generated SOMEIP segments shall be as little as possible RSSOMEIP00011 RSSOMEIP00010 RSSOMEIP00051 Note This means that the SOMEIP TP module shall try to always use the maximum allowed segmentation size SWSSomeIpTp00 003 The size of every segmented SOMEIP message shall consist of the sum of 12 bytes of SOMEIP header and the Payload bytes itself RSSOMEIP00011 SWSSomeIpTp00 004 The SOMEIP TP module shall derive the maximum possible size of the segmented SOMEIP PDUs using the parameter SomeIpTpTxNPduRef RSSOMEIP00011 RSSOMEIP00010 RSSOMEIP00051 SWSSomeIpTp00 005 The SOMEIP TP module shall generate segmented SOMEIP PDUs not larger than the size derived from the parameter SomeIpTpTxNPduRef RSSOMEIP00011 RSSOMEIP00010 RSSOMEIP00051 SWSSomeIpTp00 006 Every payload of a segmented SOMEIP message except the last one ha s to be a multiple of 16 bytes RSSOMEIP00011 RSSOMEIP00010 RSSOMEIP00027 Specification on SOMEIP Transport Protocol AUTOSAR CP R2011 18 of 59 Document ID 809AUTOSARSWSSOMEIPTransportProtocol Note The last segment may consist of an odd payload or a payload which is not dividable by 16 The amount of the contained payload bytes are written into the Length field of the SOMEIP header SWSSomeIpTp00 007 The SOMEIP TP module shall buffer the pointer to the Meta data for every PDU ID separately which is passed by the PduInfoPtr parameter of the API SomeIpTpTransmit and forward this information when PduRSomeIpTpTransmit is called for each segment Specification on SOMEIP Transport Protocol AUTOSAR CP R2011 19 of 59 Document ID 809AUTOSARSWSSOMEIPTransportProtocol 722 Header of SOMEIP segments Every generated SOMEIP header for each SOMEIP segment is set to the following values The following fields are received by the upper la yer Request ID 32 bit derived value see SWSSomeIpTp00007 Protocol Version 8 bit derived value see SWSSomeIpTp00007 Interface Version 8 bit derived value see SWSSomeIpTp00007 Message Type 8 bit calculated value see SWSSomeIpTp00008 Return C ode 8 bit derived value see SWSSomeIpTp00007 The following fie lds are added by the SOMEIP TP module Offset 28 bit calculated value see SWSSomeIpTp00 011 Reserved bits 3 bit statically set to 000 see SWS SomeIpTp00012 More Segment Flag 1 bit calculated value see SWSSomeIpTp00 013 SWSSomeIpTp00 008 The SOMEIP TP module shall store the Request ID Protocol Version Interface Version Message Type and the Return Code of the SOMEIP header for every PDU ID separately which is returned by the first call of PduRSomeIpTpCopyTxData triggered by the API call SomeIpTpTransmit RSSOMEIP00010 Note The SOMEIP header is contained in the first 8 bytes of the total length of the original SOMEIP PDU The total length is provided via the API call SomeIpTpTransmit SWSSomeIpTp00 009 If the provided SDU fits into one single PDU the provided SOME IP header shall be used with no modification If the provided SDU does not fit into one single SOMEIP PDU t he SOMEIP TP module shall set the TP Flag of the Message Type to 1 for every SOMEIP segment which is going to be sent on the bus via the Pdu R All the other bits contained in the Message Type field shall stay untouched RSSOMEIP00027 RSSOMEIP00051 SWSSomeIpTp00 010 The SOMEIP TP module shall create and attach the Offset Field the Reserved b its and the More Segment Flag to every SOMEIP segment which is going to be sent on the bus RSSOMEIP00010 RSSOMEIP00027 Specification on SOMEIP Transport Protocol AUTOSAR CP R2011 20 of 59 Document ID 809AUTOSARSWSSOMEIPTransportProtocol SWSSomeIpTp00 011 The Offset Field of the first SOMEIP segment shall be set to 0 RSSOMEIP00010 RSSOMEIP00027 SWSSomeIpTp00 012 The SOMEIP TP module shall increase the value of the Offset Field for every successfully transmitted SOMEIP segment by the amount of bytes which ha ve been transmitted by the previous SOMEIP segment divided by 16 RSSOMEIP00010 RSSOMEIP00027 RSSOMEIP00051 SWSSomeIpTp00 013 The SOMEIP TP module shall set the Reserved bits statically to 000 by the sender and shall be ignored by the receiver RSSOMEIP00010 RSSOMEIP00027 SWSSomeIpTp00 014 The SOMEIP TP module shall set the More Segment Flag to 1 except for the last SOMEIP segment RSSOMEIP00010 RSSOMEIP00027 SWSSomeIpTp00 015 The SOMEIP TP module shall set the More Segment Flag to 0 for the last SOMEIP segment RSSOMEIP00010 RSSOMEIP00027 Specification on SOMEIP Transport Protocol AUTOSAR CP R2011 21 of 59 Document ID 809AUTOSARSWSSOMEIPTransportProtocol 723 Sending of SOMEIP segments SWSSomeIpTp00 016 If the API SomeIpTpTransmit is called the SOMEIP TP module shall check for an ongoing segmentation for the provided PDU ID RSSOMEIP00010 SWSSomeIpTp00 017 If the API SomeIpTpTransmit is called while no segmentation is ongoing for this PDU ID the SOMEIP TP module shall perform the following steps in the following order Remember the provided PDU length provided PduInfoPtr Derive the PDU ID which sha ll be used for every segmented SOMEIP PDU see SomeIpTpTxNPduRef Calculate the size of the SOMEIP for the first segment considering header and payload Call the API PduRSomeIpTpTransmit using the derived PDU ID and the calculated PDU size and set the SduDataPtr to NULLPTR RSSOMEIP00010 SWSSomeIpTp00 018 When the API SomeIpTpTriggerTransmit is called create the header for the SOMEIP segment and call the API PduRSomeIpTpCopyTxData using the calculated payload for this se gment and set the parameter retry to NULLPTR RSSOMEIP00010 SWSSomeIpTp00 019 To calculate the possible maximum size for all consecutive SOMEIP TP segment s